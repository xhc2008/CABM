# 角色详细信息功能说明

## 功能概述

角色详细信息功能允许用户在创建自定义角色时上传文本文件，系统会自动构建向量数据库，在对话时提供相关的角色背景信息。

## 主要特性

### 1. 文件上传与处理
- 支持上传多个纯文本文件（.txt格式）
- 文件内容以**空行**（`\n\n`）作为分段标准
- 每个段落作为独立的知识片段存储

### 2. 向量数据库构建
- 使用与记忆系统相同的RAG配置
- 支持多路召回（BM25 + 余弦相似度）
- 自动保存到 `data/memory/<角色ID>/details.json`

### 3. 智能检索
- 在对话时与记忆检索**同时**进行
- 异步并发执行，提高响应速度
- 检索结果格式：`你的相关人物细节：{检索结果}`

### 4. 无缝集成
- 与现有记忆系统完全兼容
- 不影响原有对话流程
- 支持故事模式和普通模式
- 剧情模式下同样可以检索角色详细信息

## 使用方法

### 创建角色时上传文件

1. 在自定义角色页面找到"角色详细信息"部分
2. 点击"选择文件"上传一个或多个.txt文件
3. 文件内容示例：
```
这是角色的基本信息。
包含姓名、年龄等基础设定。

这是角色的性格描述。
详细说明角色的性格特点和行为习惯。

这是角色的背景故事。
描述角色的成长经历和重要事件。
```

### 文件格式要求

- **文件格式**：纯文本文件（.txt）
- **编码**：UTF-8
- **分段规则**：使用空行（两个连续的换行符`\n\n`）分段
- **内容建议**：每段包含一个完整的信息点

### 对话时的效果

当用户提问时，系统会：
1. 同时启动记忆检索和角色详细信息检索
2. 将检索结果添加到提示词中
3. AI根据历史记忆和角色细节生成回复

示例对话：
```
用户：你的爱好是什么？

系统内部处理：
- 记忆检索：查找相关对话历史
- 详细信息检索：查找角色爱好相关内容
- 合并结果发送给AI

AI回复：根据角色设定和历史对话，给出符合角色人设的回答
```

## 技术实现

### 核心组件

1. **CharacterDetailsService**: 角色详细信息服务
   - 管理详细信息数据库
   - 提供检索接口
   - 支持异步操作

2. **CharacterDetailsVectorDB**: 详细信息向量数据库
   - 继承自ChatHistoryVectorDB
   - 专门处理角色详细信息
   - 保存到独立的details.json文件

3. **MemoryService增强**: 记忆服务扩展
   - 新增联合检索方法
   - 支持异步并发检索
   - 自动合并检索结果

### 数据存储

```
data/
├── details/
│   └── <角色ID>.json            # 角色详细信息数据库
└── memory/
    └── <角色ID>/
        └── <角色ID>_memory.json  # 对话记忆数据库
```

### API接口

- **POST /api/custom-character**: 创建自定义角色（已扩展支持详细信息文件）
- 内部服务接口：
  - `character_details_service.build_character_details()`
  - `character_details_service.search_character_details()`
  - `memory_service.search_memory_and_details()`

## 配置说明

### RAG配置
使用与记忆系统相同的RAG配置（config.py中的RAG_CONFIG）：
- 多路召回：BM25 + 余弦相似度
- 嵌入模型：BAAI/bge-m3
- 重排序：netease-youdao/bce-reranker-base_v1

### 检索参数
- 默认返回top_k=3个最相关的详细信息片段
- 超时时间：10秒（与记忆检索相同）
- 支持自定义参数调整

## 注意事项

1. **文件大小限制**：建议单个文件不超过1MB
2. **分段质量**：确保每个段落包含完整的信息点
3. **内容相关性**：上传的内容应与角色设定相关
4. **性能考虑**：大量文件会增加检索时间
5. **存储空间**：向量数据会占用一定的磁盘空间

## 故障排除

### 常见问题

1. **文件上传失败**
   - 检查文件格式是否为.txt
   - 确认文件编码为UTF-8
   - 验证文件大小是否合理

2. **检索无结果**
   - 确认文件内容已正确分段
   - 检查查询词与文件内容的相关性
   - 查看日志确认数据库是否正确构建

3. **性能问题**
   - 减少上传文件数量
   - 优化文件内容，去除无关信息
   - 检查网络连接（API嵌入服务）

### 日志查看

系统会记录详细的操作日志：
- 文件处理过程
- 数据库构建状态
- 检索查询和结果
- 错误信息和异常

## 未来扩展

1. **支持更多文件格式**：PDF、Word等
2. **智能分段**：基于语义的自动分段
3. **内容管理**：可视化编辑和管理角色详细信息
4. **检索优化**：更精确的相关性匹配
5. **批量导入**：支持批量角色创建和管理