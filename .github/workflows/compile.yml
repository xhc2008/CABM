name: Build Windows Executable with Nuitka

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'æ„å»ºç‰ˆæœ¬å· (e.g. v1.0.0)'
        required: true
        default: 'v1.0.0'
      release_name:
        description: 'æ„å»ºåç§° (optional)'
        required: true
        default: 'v1.0.0'
      release_text:
        description: 'æ„å»ºæè¿° (optional)'
        required: true
        default: 'Windows ç¼–è¯‘ç‰ˆæœ¬'

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: ğŸ›’ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          architecture: 'x64'

      - name: ğŸ§¹ Read .nobuild file and clean excluded files
        shell: pwsh
        run: |
          # è¯»å–.nobuildæ–‡ä»¶ä¸­çš„æ’é™¤åˆ—è¡¨
          $excludedFiles = @()
          
          # æ·»åŠ .nobuildæ–‡ä»¶ä¸­æŒ‡å®šçš„æ–‡ä»¶
          if (Test-Path ".nobuild") {
            $nobuildContent = Get-Content -Path ".nobuild" | Where-Object { $_ -notmatch '^\s*#' -and $_ -match '\S' }
            $excludedFiles += $nobuildContent
            Write-Output "Loaded $($nobuildContent.Count) exclusion rules from .nobuild"
          }
          
          # åˆ é™¤æŒ‡å®šæ–‡ä»¶
          foreach ($file in $excludedFiles) {
            if (Test-Path $file) {
              Remove-Item -Path $file -Force
              Write-Output "Removed excluded file: $file"
            }
          }
          
          # æ¸…ç†ç©ºç›®å½•
          Get-ChildItem -Directory | Where-Object { 
            (Get-ChildItem -Path $_.FullName -Recurse -File).Count -eq 0 
          } | Remove-Item -Recurse -Force

      - name: ğŸ“¦ Install dependencies
        shell: pwsh
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install nuitka

      - name: ğŸ–¥ï¸ Build Windows executable with Nuitka
        shell: pwsh
        run: |
          # æ„å»º EXE (ç›´æ¥ä½¿ç”¨pythonå‘½ä»¤)
          python -m nuitka --assume-yes-for-downloads --standalone --mingw64 --enable-plugin=pylint-warnings --include-package=services --include-package=utils --include-package=utils.RAG --include-package=utils.RAG.Multi_Recall --include-package=utils.RAG.Reranker --output-dir=dist start.py

          # ä¿ç•™ characters ç›®å½•ï¼ˆDLC æ’ä»¶ï¼‰
          if (Test-Path "characters") {
            Copy-Item -Path "characters" -Destination "dist\start.dist\characters" -Recurse -Force
          }
          
          # å¤åˆ¶é™æ€èµ„æºå’Œæ¨¡æ¿
          if (Test-Path "static") {
            Copy-Item -Path "static" -Destination "dist\start.dist\static" -Recurse -Force
          }
          if (Test-Path "templates") {
            Copy-Item -Path "templates" -Destination "dist\start.dist\templates" -Recurse -Force
          }
          if (Test-Path "config") {
            Copy-Item -Path "config" -Destination "dist\start.dist\config" -Recurse -Force
          }
          
          # é‡å‘½å dist ç›®å½•ä¸º app
          Move-Item -Path "dist\start.dist" -Destination "app" -Force

      - name: ğŸ—‘ï¸ Cleanup build artifacts
        shell: pwsh
        run: |
          Remove-Item -Path "dist", "start.build" -Recurse -Force -ErrorAction Ignore
          Remove-Item -Path "*.spec" -Force -ErrorAction Ignore

      - name: ğŸ“¦ Package release (copy to root and compress)
        shell: pwsh
        run: |
          # å°† app ç›®å½•å†…å®¹å¤åˆ¶åˆ°æ ¹ç›®å½•ï¼ˆå¦‚æœ‰åŒåå…ˆåˆ é™¤ï¼‰
          Get-ChildItem -Path "app" | ForEach-Object {
            $dest = Join-Path "." $_.Name
            if (Test-Path $dest) {
              Remove-Item -Path $dest -Recurse -Force
            }
            Move-Item -Path $_.FullName -Destination "." -Force
          }
          
          # åˆ é™¤ç©ºçš„ app ç›®å½•
          Remove-Item -Path "app" -Recurse -Force
          
          # é‡å‘½å start.exe ä¸º app.exe
          if (Test-Path "start.exe") {
            Move-Item -Path "start.exe" -Destination "app.exe" -Force
          }
          
          # å‹ç¼©æ•´ä¸ªç›®å½•
          Compress-Archive -Path * -DestinationPath "Windows-Release-${{ inputs.version }}.zip" -Force

      - name: ğŸ—‘ï¸ Delete existing release if exists
        shell: pwsh
        run: |
          # åˆ é™¤ releaseï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          try {
            gh release delete "${{ inputs.version }}" --yes
          } catch {
            Write-Output "Release not found, skip delete."
          }

          # åˆ é™¤æœ¬åœ° tagï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if (git tag | Select-String -Pattern "${{ inputs.version }}") {
            git tag -d "${{ inputs.version }}"
          }

          # åˆ é™¤è¿œç¨‹ tagï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if (git ls-remote --tags origin | Select-String -Pattern "refs/tags/${{ inputs.version }}") {
            git push --delete origin "${{ inputs.version }}"
          }

      - name: ğŸš€ Create Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "${{ inputs.version }}" `
            --title "${{ inputs.release_name || inputs.version }}" `
            --notes "${{ inputs.release_text }}" `
            "Windows-Release-${{ inputs.version }}.zip"