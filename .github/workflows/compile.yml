name: Create Release Package

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g. v1.0.0)'
        required: true
        default: 'v1.0.0'
      release_name:
        description: 'Release title (optional)'
        required: false

permissions:
  contents: write

jobs:
  build-release:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ›’ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: âš™ï¸ Create virtual environment
        run: |
          python -m venv venv
          source venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: ğŸ“¦ Package application (with dependencies)
        run: |
          # åˆ›å»ºå‘å¸ƒç›®å½•ç»“æ„
          mkdir -p dist/app
          
          # å¤åˆ¶é¡¹ç›®æ–‡ä»¶ï¼ˆæ’é™¤å¼€å‘ä¸“ç”¨æ–‡ä»¶ï¼‰
          rsync -r --exclude '.git' --exclude '.github' --exclude 'venv' \
                --exclude '*.pyc' --exclude '__pycache__' . dist/app/
          
          # å¤åˆ¶è™šæ‹Ÿç¯å¢ƒ
          cp -r venv dist/
          
          # åˆ›å»ºå¯åŠ¨è„šæœ¬ï¼ˆé€‚é… start.py å…¥å£æ–‡ä»¶ï¼‰
          cat > dist/run.sh <<'EOF'
#!/bin/bash
source venv/bin/activate
cd app
python start.py
EOF
          chmod +x dist/run.sh
          
          # æ‰“åŒ…ä¸ºZIP
          zip -r "release-${{ inputs.version }}.zip" dist

      - name: ğŸš€ Create Release & Upload Asset
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "${{ inputs.version }}" \
            --title "${{ inputs.release_name || inputs.version }}" \
            --notes "Release with dependencies for Flask application" \
            "release-${{ inputs.version }}.zip"