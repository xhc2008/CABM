name: Build Windows Executable with Nuitka

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g. v1.0.0)'
        required: true
        default: 'v1.0.0'
      release_name:
        description: 'Release title (optional)'
        required: false

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: ğŸ›’ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          architecture: 'x64'

      - name: âš™ï¸ Install Visual Studio Build Tools
        shell: pwsh
        run: |
          # å®‰è£… VS 2022 æ„å»ºå·¥å…·ï¼ˆåŒ…å« C++ ç¼–è¯‘å™¨ï¼‰
          choco install visualstudio2022buildtools --no-progress --yes `
            --package-parameters="'--add Microsoft.VisualStudio.Workload.VCTools --includeRecommended'"
          
          # éªŒè¯å®‰è£…
          vswhere.exe -latest -products * -requires Microsoft.VisualStudio.Component.VC.Tools.x86.x64

      - name: ğŸ§¹ Read .nobuild file and clean excluded files
        shell: pwsh
        run: |
          # è¯»å–.nobuildæ–‡ä»¶ä¸­çš„æ’é™¤åˆ—è¡¨
          $excludedFiles = @(
            "docker-compose.dockerhub.yml",
            "docker-compose.yml",
            "Dockerfile",
            "package-lock.json",
            "package.json",
            "release.sh",
            "deploy.ps1",
            "deploy.sh",
            "deploy-docker.sh",
            "cabm-gui.ps1",
            "å¯åŠ¨æ²™é›•UIç¬¬äºŒä»£.bat",
            ".gitignore",
            ".gitattributes",
            ".dockerignore"
          )
          
          # æ·»åŠ .nobuildæ–‡ä»¶ä¸­æŒ‡å®šçš„æ–‡ä»¶
          if (Test-Path ".nobuild") {
            $nobuildContent = Get-Content -Path ".nobuild" | Where-Object { $_ -notmatch '^\s*#' -and $_ -match '\S' }
            $excludedFiles += $nobuildContent
            Write-Output "Loaded $($nobuildContent.Count) exclusion rules from .nobuild"
          }
          
          # åˆ é™¤æŒ‡å®šæ–‡ä»¶
          foreach ($file in $excludedFiles) {
            if (Test-Path $file) {
              Remove-Item -Path $file -Force
              Write-Output "Removed excluded file: $file"
            }
          }
          
          # æ¸…ç†ç©ºç›®å½•
          Get-ChildItem -Directory | Where-Object { 
            (Get-ChildItem -Path $_.FullName -Recurse -File).Count -eq 0 
          } | Remove-Item -Recurse -Force

      - name: ğŸ“¦ Install dependencies
        shell: pwsh
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install nuitka

      - name: ğŸ–¥ï¸ Build Windows executable with Nuitka
        shell: pwsh
        run: |
          # è®¾ç½® MSVC ç¯å¢ƒï¼ˆNuitka éœ€è¦ï¼‰
          $vsPath = vswhere.exe -latest -property installationPath
          $vcVarsPath = Join-Path $vsPath "VC\Auxiliary\Build\vcvarsall.bat"
          cmd.exe /c "`"$vcVarsPath`" amd64 && set" | ForEach-Object {
              if ($_ -match "(\w+)=(.*)") {
                  [System.Environment]::SetEnvironmentVariable($matches[1], $matches[2])
              }
          }
          
          # æ„å»º EXE (ä½¿ç”¨cmd.exeæ‰§è¡Œï¼Œé¿å…PowerShellè§£æé—®é¢˜)
          cmd.exe /c "python -m nuitka --standalone --mingw64 --enable-plugin=multiprocessing --enable-plugin=numpy --enable-plugin=pylint-warnings --include-package=services --include-package=utils --include-package=utils.RAG --include-package=utils.RAG.Multi_Recall --include-package=utils.RAG.Reranker --windows-disable-console=off --output-dir=dist start.py"

          # ä¿ç•™ characters ç›®å½•ï¼ˆDLC æ’ä»¶ï¼‰
          if (Test-Path "characters") {
            Copy-Item -Path "characters" -Destination "dist\start.dist\characters" -Recurse -Force
          }
          
          # å¤åˆ¶é™æ€èµ„æºå’Œæ¨¡æ¿
          if (Test-Path "static") {
            Copy-Item -Path "static" -Destination "dist\start.dist\static" -Recurse -Force
          }
          if (Test-Path "templates") {
            Copy-Item -Path "templates" -Destination "dist\start.dist\templates" -Recurse -Force
          }
          if (Test-Path "config") {
            Copy-Item -Path "config" -Destination "dist\start.dist\config" -Recurse -Force
          }
          
          # é‡å‘½å dist ç›®å½•ä¸º app
          Move-Item -Path "dist\start.dist" -Destination "app" -Force

      - name: ğŸ—‘ï¸ Cleanup build artifacts
        shell: pwsh
        run: |
          Remove-Item -Path "dist", "start.build" -Recurse -Force -ErrorAction Ignore
          Remove-Item -Path "*.spec" -Force -ErrorAction Ignore

      - name: ğŸ“¦ Package release (copy to root and compress)
        shell: pwsh
        run: |
          # å°† app ç›®å½•å†…å®¹å¤åˆ¶åˆ°æ ¹ç›®å½•
          Get-ChildItem -Path "app" | ForEach-Object {
            Move-Item -Path $_.FullName -Destination "." -Force
          }
          
          # åˆ é™¤ç©ºçš„ app ç›®å½•
          Remove-Item -Path "app" -Recurse -Force
          
          # é‡å‘½å start.exe ä¸º app.exe
          if (Test-Path "start.exe") {
            Move-Item -Path "start.exe" -Destination "app.exe" -Force
          }
          
          # å‹ç¼©æ•´ä¸ªç›®å½•
          Compress-Archive -Path * -DestinationPath "Windows-Release-${{ inputs.version }}.zip" -Force

      - name: ğŸš€ Create Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "${{ inputs.version }}" `
            --title "${{ inputs.release_name || inputs.version }}" `
            --notes "Windows release built with Nuitka (standalone mode, with console)" `
            "Windows-Release-${{ inputs.version }}.zip"