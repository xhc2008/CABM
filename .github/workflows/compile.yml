name: Build Windows Executable with Console

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g. v1.0.0)'
        required: true
        default: 'v1.0.0'
      release_name:
        description: 'Release title (optional)'
        required: false

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: ğŸ›’ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          architecture: 'x64'

      - name: âš™ï¸ Install Visual Studio Build Tools
        shell: pwsh
        run: |
          # å®‰è£… VS 2022 æ„å»ºå·¥å…·ï¼ˆåŒ…å« C++ ç¼–è¯‘å™¨ï¼‰
          choco install visualstudio2022buildtools --no-progress --yes `
            --package-parameters="'--add Microsoft.VisualStudio.Workload.VCTools --includeRecommended'"
          
          # éªŒè¯å®‰è£…
          vswhere.exe -latest -products * -requires Microsoft.VisualStudio.Component.VC.Tools.x86.x64

      - name: ğŸ§¹ Read .nobuild file and clean excluded files
        shell: pwsh
        run: |
          # è¯»å–.nobuildæ–‡ä»¶ä¸­çš„æ’é™¤åˆ—è¡¨
          $excludedFiles = @(
            "docker-compose.dockerhub.yml",
            "docker-compose.yml",
            "Dockerfile",
            "package-lock.json",
            "package.json",
            "release.sh",
            "requirements.txt",
            "deploy.ps1",
            "deploy.sh",
            "deploy-docker.sh",
            "cabm-gui.ps1",
            "å¯åŠ¨æ²™é›•UIç¬¬äºŒä»£.bat",
            ".gitignore",
            ".gitattributes",
            ".dockerignore"
          )
          
          # æ·»åŠ .nobuildæ–‡ä»¶ä¸­æŒ‡å®šçš„æ–‡ä»¶
          if (Test-Path ".nobuild") {
            $nobuildContent = Get-Content -Path ".nobuild" | Where-Object { $_ -notmatch '^\s*#' -and $_ -match '\S' }
            $excludedFiles += $nobuildContent
            Write-Output "Loaded $($nobuildContent.Count) exclusion rules from .nobuild"
          }
          
          # åˆ é™¤æŒ‡å®šæ–‡ä»¶
          foreach ($file in $excludedFiles) {
            if (Test-Path $file) {
              Remove-Item -Path $file -Force
              Write-Output "Removed excluded file: $file"
            }
          }
          
          # æ¸…ç†ç©ºç›®å½•
          Get-ChildItem -Directory | Where-Object { 
            (Get-ChildItem -Path $_.FullName -Recurse -File).Count -eq 0 
          } | Remove-Item -Recurse -Force

      - name: ğŸ”§ Create distutils.cfg for Cython
        shell: pwsh
        run: |
          # æ­£ç¡®è·å–Pythonå®‰è£…è·¯å¾„
          $pythonHome = (python -c "import sys; print(sys.prefix)").Trim()
          $distutilsPath = Join-Path $pythonHome "Lib\distutils"
          
          # ç¡®ä¿ç›®å½•å­˜åœ¨
          if (-not (Test-Path $distutilsPath)) {
              New-Item -ItemType Directory -Path $distutilsPath -Force
          }
          
          # åˆ›å»ºdistutilsé…ç½®
          $distutilsCfg = @"
          [build]
          compiler = msvc
          
          [build_ext]
          compiler = msvc
          "@
          
          $distutilsCfg | Out-File -FilePath (Join-Path $distutilsPath "distutils.cfg") -Encoding UTF8
          
          # éªŒè¯æ–‡ä»¶åˆ›å»º
          Write-Output "Created distutils.cfg at $(Join-Path $distutilsPath "distutils.cfg")"
          Get-Content (Join-Path $distutilsPath "distutils.cfg")

      - name: ğŸ”’ Setup MSVC environment for Cython
        shell: pwsh
        run: |
          # è®¾ç½® MSVC ç¯å¢ƒå˜é‡
          $vsPath = vswhere.exe -latest -property installationPath
          $vcVarsPath = Join-Path $vsPath "VC\Auxiliary\Build\vcvarsall.bat"
          cmd.exe /c "`"$vcVarsPath`" amd64 && set" | ForEach-Object {
              if ($_ -match "(\w+)=(.*)") {
                  [System.Environment]::SetEnvironmentVariable($matches[1], $matches[2])
              }
          }
          
          # éªŒè¯ cl.exe å¯ç”¨
          cl.exe /?

      - name: ğŸ”’ Install cython with C++ compiler
        shell: pwsh
        run: |
          pip install cython wheel setuptools

      - name: ğŸ”’ Compile .py to .pyd (proper package structure)
        shell: pwsh
        run: |
          # åˆ›å»ºç¼–è¯‘è„šæœ¬ï¼ˆæ­£ç¡®å¤„ç†PythonåŒ…ç»“æ„ï¼‰
          $compileScript = @'
          import os
          import subprocess
          import sys
          from pathlib import Path
          
          def is_package(directory):
              """æ£€æŸ¥ç›®å½•æ˜¯å¦ä¸ºPythonåŒ…ï¼ˆåŒ…å«__init__.pyï¼‰"""
              return (Path(directory) / "__init__.py").exists()
          
          def compile_to_pyd(file_path):
              file_path = Path(file_path)
              # æ’é™¤ç‰¹æ®Šæ–‡ä»¶
              if (file_path.name in ['start.py', 'compile_to_pyd.py'] or
                  'site-packages' in str(file_path) or
                  '__pycache__' in str(file_path) or
                  file_path.name.endswith('.spec') or
                  file_path.name.endswith('.c') or
                  file_path.name.endswith('.pyd') or
                  'characters' in str(file_path)):
                  print(f"Skipping {file_path} (entry point, special file or DLC plugin)")
                  return
              
              # å¤„ç†åŒ…ä¸­çš„__init__.py - ä¿ç•™ä¸º.pyæ–‡ä»¶ï¼Œä¸ç¼–è¯‘
              if file_path.name == '__init__.py' and is_package(file_path.parent):
                  print(f"Preserving {file_path} as package initializer (not compiling)")
                  return
                  
              print(f"Compiling {file_path} to .pyd...")
              
              # 1. ç”ŸæˆCä»£ç 
              try:
                  # ä½¿ç”¨ç»å¯¹è·¯å¾„
                  abs_path = os.path.abspath(file_path)
                  result = subprocess.run([
                      'python', '-m', 'cython', 
                      '--embed', 
                      '--cplus',
                      '-3',
                      abs_path
                  ], capture_output=True, text=True, check=True)
                  
                  if result.stderr:
                      print(f"Cython warnings: {result.stderr}")
              except subprocess.CalledProcessError as e:
                  print(f"ERROR: Cython failed for {file_path}")
                  print(f"Command: {e.cmd}")
                  print(f"Return code: {e.returncode}")
                  print(f"Stdout: {e.stdout}")
                  print(f"Stderr: {e.stderr}")
                  raise
              
              # 2. éªŒè¯.cæ–‡ä»¶å­˜åœ¨
              c_file = file_path.with_suffix('.c')
              if not c_file.exists():
                  raise FileNotFoundError(f"Missing {c_file} after Cython processing")
              
              # 3. ç¼–è¯‘.cåˆ°.pyd
              pyd_file = file_path.with_suffix('.pyd')
              print(f"Compiling {c_file} to {pyd_file}...")
              try:
                  # ä½¿ç”¨ç»å¯¹è·¯å¾„
                  abs_c_file = os.path.abspath(c_file)
                  abs_pyd_file = os.path.abspath(pyd_file)
                  
                  subprocess.run([
                      'cl', '/LD', 
                      '/I%PYTHONHOME%\\include',
                      '/I%PYTHONHOME%\\Lib\\site-packages\\numpy\\core\\include',
                      '/link', '/LIBPATH:%PYTHONHOME%\\libs',
                      abs_c_file,
                      f'/out:{abs_pyd_file}'
                  ], shell=True, check=True)
              except subprocess.CalledProcessError as e:
                  print(f"ERROR: MSVC failed for {file_path}")
                  print(f"Command: {e.cmd}")
                  print(f"Return code: {e.returncode}")
                  print(f"Stdout: {e.stdout}")
                  print(f"Stderr: {e.stderr}")
                  raise
              
              # 4. æ¸…ç†
              try:
                  os.remove(c_file)
                  print(f"Successfully compiled {file_path} to {pyd_file}")
              except Exception as e:
                  print(f"Warning: Could not remove {c_file}: {str(e)}")
          
          # å¤„ç†æ‰€æœ‰.pyæ–‡ä»¶
          pyd_count = 0
          for root, _, files in os.walk('.'):
              for file in files:
                  if file.endswith('.py') and not file.startswith('.'):
                      try:
                          compile_to_pyd(os.path.join(root, file))
                          pyd_count += 1
                      except Exception as e:
                          print(f"Failed to compile {os.path.join(root, file)}: {str(e)}")
          
          # ç¡®è®¤è‡³å°‘æœ‰ä¸€ä¸ª.pydæ–‡ä»¶è¢«åˆ›å»º
          if pyd_count == 0:
              raise RuntimeError("No .pyd files were created. Compilation failed for all files.")
          print(f"Successfully created {pyd_count} .pyd files")
          '@
          
          $compileScript | Out-File -FilePath "compile_to_pyd.py" -Encoding UTF8
          
          # è¿è¡Œç¼–è¯‘
          python compile_to_pyd.py
          
          # åˆ é™¤åŸå§‹.pyæ–‡ä»¶ï¼ˆä½†ä¿ç•™æ‰€æœ‰__init__.pyæ–‡ä»¶ï¼‰
          Get-ChildItem -Path . -Include *.py -Recurse | 
            Where-Object { 
                $_.Name -notin @('start.py', 'compile_to_pyd.py') -and
                $_.Name -ne '__init__.py' -and
                -not $_.DirectoryName.Contains('characters')
            } | Remove-Item -Force

      - name: ğŸ“¦ Install dependencies
        shell: pwsh
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: ğŸ–¥ï¸ Build Windows executable (WITH CONSOLE)
        shell: pwsh
        run: |
          # è®¾ç½® MSVC ç¯å¢ƒï¼ˆPyInstaller éœ€è¦ï¼‰
          $vsPath = vswhere.exe -latest -property installationPath
          $vcVarsPath = Join-Path $vsPath "VC\Auxiliary\Build\vcvarsall.bat"
          cmd.exe /c "`"$vcVarsPath`" amd64 && set" | ForEach-Object {
              if ($_ -match "(\w+)=(.*)") {
                  [System.Environment]::SetEnvironmentVariable($matches[1], $matches[2])
              }
          }
          
          # æ„å»º EXE (ä¿ç•™æ§åˆ¶å°çª—å£)
          pyinstaller `
            --onefile `
            --name "app" `
            --add-data "static;static" `
            --add-data "templates;templates" `
            --paths "." `
            --hidden-import "services" `
            --hidden-import "utils" `
            --hidden-import "utils.RAG" `
            --hidden-import "utils.RAG.Multi_Recall" `
            --hidden-import "utils.RAG.Reranker" `
            start.py

          # ç§»åŠ¨ EXE åˆ°æ ¹ç›®å½•
          Move-Item -Path "dist\\app.exe" -Destination "." -Force

      - name: ğŸ—‘ï¸ Cleanup build artifacts
        shell: pwsh
        run: |
          Remove-Item -Path "build", "dist", "*.c", "*.o", "compile_to_pyd.py" -Recurse -Force -ErrorAction Ignore
          Remove-Item -Path "*.spec" -Force -ErrorAction Ignore

      - name: ğŸ“¦ Package release
        shell: pwsh
        run: |
          Compress-Archive -Path * -DestinationPath "Windows-Release-${{ inputs.version }}.zip" -Force

      - name: ğŸš€ Create Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "${{ inputs.version }}" `
            --title "${{ inputs.release_name || inputs.version }}" `
            --notes "Windows release with console and .py files compiled to .pyd (proper package structure)" `
            "Windows-Release-${{ inputs.version }}.zip"