name: Build Executables with Nuitka (Multi-Arch)

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'æ„å»ºç‰ˆæœ¬å· (e.g. v1.0.0)'
        required: true
        default: 'v0.0.0'
      release_name:
        description: 'æ„å»ºåç§° (optional)'
        required: true
        default: 'Multi-Arch ç¼–è¯‘ç‰ˆæœ¬'
      release_text:
        description: 'æ„å»ºæè¿° (optional)'
        required: true
        default: 'æ”¯æŒ Windows/Linux/macOS å¤šæ¶æ„'

permissions:
  contents: write

jobs:
  # ==================== WINDOWS JOBS ====================
  build-windows-x64-full:
    runs-on: windows-latest
    timeout-minutes: 120
    steps: &windows-steps
      - name: ğŸ›’ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python (x64)
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          architecture: 'x64'

      - name: ğŸ§¹ Clean excluded files (.nobuild)
        shell: pwsh
        run: |
          $excludedFiles = @()
          if (Test-Path ".nobuild") {
            $nobuildContent = Get-Content -Path ".nobuild" | Where-Object { $_ -notmatch '^\s*#' -and $_ -match '\S' }
            $excludedFiles += $nobuildContent
            Write-Output "Loaded $($nobuildContent.Count) exclusion rules from .nobuild"
          }
          foreach ($file in $excludedFiles) {
            if (Test-Path $file) {
              Remove-Item -Path $file -Force
              Write-Output "Removed: $file"
            }
          }
          Get-ChildItem -Directory | Where-Object { (Get-ChildItem -Path $_.FullName -Recurse -File).Count -eq 0 } | Remove-Item -Recurse -Force

      - name: ğŸ“¦ Install dependencies (Full)
        shell: pwsh
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install nuitka
          pip install rank_bm25 jieba torch tqdm

      - name: ğŸ–¥ï¸ Build Windows executable
        shell: pwsh
        run: |
          python -m nuitka --assume-yes-for-downloads --standalone --mingw64 --enable-plugin=pylint-warnings --include-package=services --include-package=utils --include-package=utils.RAG --include-package=utils.RAG.Multi_Recall --include-package=utils.RAG.Reranker --include-package=rtoml --output-dir=dist start.py

          if (Test-Path "characters") { Copy-Item -Path "characters" -Destination "dist\start.dist\characters" -Recurse -Force }
          if (Test-Path "data")       { Copy-Item -Path "data"       -Destination "dist\start.dist\data"       -Recurse -Force }
          if (Test-Path "static")     { Copy-Item -Path "static"     -Destination "dist\start.dist\static"     -Recurse -Force }
          if (Test-Path "templates")  { Copy-Item -Path "templates"  -Destination "dist\start.dist\templates"  -Recurse -Force }
          if (Test-Path "config")     { Copy-Item -Path "config"     -Destination "dist\start.dist\config"     -Recurse -Force }

          Move-Item -Path "dist\start.dist" -Destination "app" -Force

      - name: ğŸ—‘ï¸ Cleanup artifacts
        shell: pwsh
        run: |
          Remove-Item -Path "dist", "start.build" -Recurse -Force -ErrorAction Ignore
          Remove-Item -Path "*.spec" -Force -ErrorAction Ignore

      - name: ğŸ“¦ Package Windows release
        shell: pwsh
        run: |
          Get-ChildItem -Path "app" | ForEach-Object {
            $dest = Join-Path "." $_.Name
            if (Test-Path $dest) { Remove-Item -Path $dest -Recurse -Force }
            Move-Item -Path $_.FullName -Destination "." -Force
          }
          Remove-Item -Path "app" -Recurse -Force
          if (Test-Path "start.exe") { Move-Item -Path "start.exe" -Destination "app.exe" -Force }
          Compress-Archive -Path * -DestinationPath "Windows-x64-Full-Release-${{ inputs.version }}.zip" -Force

      - name: ğŸ“¤ Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Windows-x64-Full-Release-${{ inputs.version }}
          path: Windows-x64-Full-Release-${{ inputs.version }}.zip

  build-windows-x64-lite:
    runs-on: windows-latest
    timeout-minutes: 120
    steps: *windows-steps # å¤ç”¨å®Œæ•´ç‰ˆæ­¥éª¤ï¼Œä½†ä¸å®‰è£…é¢å¤–ä¾èµ–

  build-windows-x86-full:
    runs-on: windows-2022
    timeout-minutes: 120
    steps:
      - name: ğŸ›’ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python (x86)
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          architecture: 'x86'

      - name: ğŸ§¹ Clean excluded files (.nobuild)
        shell: pwsh
        run: |
          $excludedFiles = @()
          if (Test-Path ".nobuild") {
            $nobuildContent = Get-Content -Path ".nobuild" | Where-Object { $_ -notmatch '^\s*#' -and $_ -match '\S' }
            $excludedFiles += $nobuildContent
            Write-Output "Loaded $($nobuildContent.Count) exclusion rules from .nobuild"
          }
          foreach ($file in $excludedFiles) {
            if (Test-Path $file) {
              Remove-Item -Path $file -Force
              Write-Output "Removed: $file"
            }
          }
          Get-ChildItem -Directory | Where-Object { (Get-ChildItem -Path $_.FullName -Recurse -File).Count -eq 0 } | Remove-Item -Recurse -Force

      - name: ğŸ“¦ Install dependencies (Full)
        shell: pwsh
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install nuitka
          pip install rank_bm25 jieba torch tqdm

      - name: ğŸ–¥ï¸ Build Windows x86 executable
        shell: pwsh
        run: |
          python -m nuitka --assume-yes-for-downloads --standalone --mingw64 --enable-plugin=pylint-warnings --include-package=services --include-package=utils --include-package=utils.RAG --include-package=utils.RAG.Multi_Recall --include-package=utils.RAG.Reranker --include-package=rtoml --output-dir=dist start.py

          if (Test-Path "characters") { Copy-Item -Path "characters" -Destination "dist\start.dist\characters" -Recurse -Force }
          if (Test-Path "data")       { Copy-Item -Path "data"       -Destination "dist\start.dist\data"       -Recurse -Force }
          if (Test-Path "static")     { Copy-Item -Path "static"     -Destination "dist\start.dist\static"     -Recurse -Force }
          if (Test-Path "templates")  { Copy-Item -Path "templates"  -Destination "dist\start.dist\templates"  -Recurse -Force }
          if (Test-Path "config")     { Copy-Item -Path "config"     -Destination "dist\start.dist\config"     -Recurse -Force }

          Move-Item -Path "dist\start.dist" -Destination "app" -Force

      - name: ğŸ—‘ï¸ Cleanup artifacts
        shell: pwsh
        run: |
          Remove-Item -Path "dist", "start.build" -Recurse -Force -ErrorAction Ignore
          Remove-Item -Path "*.spec" -Force -ErrorAction Ignore

      - name: ğŸ“¦ Package Windows x86 release
        shell: pwsh
        run: |
          Get-ChildItem -Path "app" | ForEach-Object {
            $dest = Join-Path "." $_.Name
            if (Test-Path $dest) { Remove-Item -Path $dest -Recurse -Force }
            Move-Item -Path $_.FullName -Destination "." -Force
          }
          Remove-Item -Path "app" -Recurse -Force
          if (Test-Path "start.exe") { Move-Item -Path "start.exe" -Destination "app.exe" -Force }
          Compress-Archive -Path * -DestinationPath "Windows-x86-Full-Release-${{ inputs.version }}.zip" -Force

      - name: ğŸ“¤ Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Windows-x86-Full-Release-${{ inputs.version }}
          path: Windows-x86-Full-Release-${{ inputs.version }}.zip

  build-windows-x86-lite:
    runs-on: windows-2022
    timeout-minutes: 120
    steps: # å¤ç”¨å®Œæ•´ç‰ˆæ­¥éª¤ï¼Œä½†ä¸å®‰è£…é¢å¤–ä¾èµ–
      - name: ğŸ›’ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python (x86)
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          architecture: 'x86'

      - name: ğŸ§¹ Clean excluded files (.nobuild)
        shell: pwsh
        run: |
          $excludedFiles = @()
          if (Test-Path ".nobuild") {
            $nobuildContent = Get-Content -Path ".nobuild" | Where-Object { $_ -notmatch '^\s*#' -and $_ -match '\S' }
            $excludedFiles += $nobuildContent
            Write-Output "Loaded $($nobuildContent.Count) exclusion rules from .nobuild"
          }
          foreach ($file in $excludedFiles) {
            if (Test-Path $file) {
              Remove-Item -Path $file -Force
              Write-Output "Removed: $file"
            }
          }
          Get-ChildItem -Directory | Where-Object { (Get-ChildItem -Path $_.FullName -Recurse -File).Count -eq 0 } | Remove-Item -Recurse -Force

      - name: ğŸ“¦ Install dependencies (Lite)
        shell: pwsh
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install nuitka

      - name: ğŸ–¥ï¸ Build Windows x86 executable
        shell: pwsh
        run: |
          python -m nuitka --assume-yes-for-downloads --standalone --mingw64 --enable-plugin=pylint-warnings --include-package=services --include-package=utils --include-package=utils.RAG --include-package=utils.RAG.Multi_Recall --include-package=utils.RAG.Reranker --include-package=rtoml --output-dir=dist start.py

          if (Test-Path "characters") { Copy-Item -Path "characters" -Destination "dist\start.dist\characters" -Recurse -Force }
          if (Test-Path "data")       { Copy-Item -Path "data"       -Destination "dist\start.dist\data"       -Recurse -Force }
          if (Test-Path "static")     { Copy-Item -Path "static"     -Destination "dist\start.dist\static"     -Recurse -Force }
          if (Test-Path "templates")  { Copy-Item -Path "templates"  -Destination "dist\start.dist\templates"  -Recurse -Force }
          if (Test-Path "config")     { Copy-Item -Path "config"     -Destination "dist\start.dist\config"     -Recurse -Force }

          Move-Item -Path "dist\start.dist" -Destination "app" -Force

      - name: ğŸ—‘ï¸ Cleanup artifacts
        shell: pwsh
        run: |
          Remove-Item -Path "dist", "start.build" -Recurse -Force -ErrorAction Ignore
          Remove-Item -Path "*.spec" -Force -ErrorAction Ignore

      - name: ğŸ“¦ Package Windows x86 release
        shell: pwsh
        run: |
          Get-ChildItem -Path "app" | ForEach-Object {
            $dest = Join-Path "." $_.Name
            if (Test-Path $dest) { Remove-Item -Path $dest -Recurse -Force }
            Move-Item -Path $_.FullName -Destination "." -Force
          }
          Remove-Item -Path "app" -Recurse -Force
          if (Test-Path "start.exe") { Move-Item -Path "start.exe" -Destination "app.exe" -Force }
          Compress-Archive -Path * -DestinationPath "Windows-x86-Lite-Release-${{ inputs.version }}.zip" -Force

      - name: ğŸ“¤ Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Windows-x86-Lite-Release-${{ inputs.version }}
          path: Windows-x86-Lite-Release-${{ inputs.version }}.zip

  # ==================== LINUX JOBS ====================
  build-linux-x64-full:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    steps: &linux-steps
      - name: ğŸ›’ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: ğŸ§¹ Clean excluded files (.nobuild)
        run: |
          if [ -f .nobuild ]; then
            while IFS= read -r line; do
              [[ -z "$line" || "$line" =~ ^[[:space:]]*# ]] && continue
              if [ -e "$line" ]; then
                rm -rf "$line"
                echo "Removed: $line"
              fi
            done < .nobuild
          fi
          find . -type d -empty -delete

      - name: ğŸ“¦ Install dependencies (Full)
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install nuitka
          pip install rank_bm25 jieba torch tqdm

      - name: ğŸ§ Build Linux executable
        run: |
          python -m nuitka --assume-yes-for-downloads --standalone --enable-plugin=pylint-warnings --include-package=services --include-package=utils --include-package=utils.RAG --include-package=utils.RAG.Multi_Recall --include-package=utils.RAG.Reranker --include-package=rtoml --output-dir=dist start.py

          mkdir -p dist/start.dist/characters dist/start.dist/data dist/start.dist/static dist/start.dist/templates dist/start.dist/config
          [ -d characters ] && cp -r characters dist/start.dist/
          [ -d data ]       && cp -r data       dist/start.dist/
          [ -d static ]     && cp -r static     dist/start.dist/
          [ -d templates ]  && cp -r templates  dist/start.dist/
          [ -d config ]     && cp -r config     dist/start.dist/

          mv dist/start.dist app

      - name: ğŸ—‘ï¸ Cleanup artifacts
        run: |
          rm -rf dist start.build *.spec

      - name: ğŸ“¦ Package Linux release
        run: |
          # åˆ é™¤å¯èƒ½å†²çªçš„ç›®å½•
          rm -rf characters data static templates config

          # ç§»åŠ¨ app å†…å®¹åˆ°æ ¹ç›®å½•
          mv app/* ./
          rmdir app

          # é‡å‘½åå¯æ‰§è¡Œæ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          [ -f start ] && mv start app

          # å‹ç¼©ä¸º zip
          zip -r Linux-x64-Full-Release-${{ inputs.version }}.zip . -x "*.git*" -x "*.zip"

      - name: ğŸ“¤ Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Linux-x64-Full-Release-${{ inputs.version }}
          path: Linux-x64-Full-Release-${{ inputs.version }}.zip

  build-linux-x64-lite:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    steps: *linux-steps # å¤ç”¨å®Œæ•´ç‰ˆæ­¥éª¤ï¼Œä½†ä¸å®‰è£…é¢å¤–ä¾èµ–

  build-linux-arm64-full:
    runs-on: ubuntu-latest-arm64
    timeout-minutes: 120
    steps:
      - name: ğŸ›’ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: ğŸ§¹ Clean excluded files (.nobuild)
        run: |
          if [ -f .nobuild ]; then
            while IFS= read -r line; do
              [[ -z "$line" || "$line" =~ ^[[:space:]]*# ]] && continue
              if [ -e "$line" ]; then
                rm -rf "$line"
                echo "Removed: $line"
              fi
            done < .nobuild
          fi
          find . -type d -empty -delete

      - name: ğŸ“¦ Install dependencies (Full)
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install nuitka
          pip install rank_bm25 jieba torch tqdm

      - name: ğŸ§ Build Linux ARM64 executable
        run: |
          python -m nuitka --assume-yes-for-downloads --standalone --enable-plugin=pylint-warnings --include-package=services --include-package=utils --include-package=utils.RAG --include-package=utils.RAG.Multi_Recall --include-package=utils.RAG.Reranker --include-package=rtoml --output-dir=dist start.py

          mkdir -p dist/start.dist/characters dist/start.dist/data dist/start.dist/static dist/start.dist/templates dist/start.dist/config
          [ -d characters ] && cp -r characters dist/start.dist/
          [ -d data ]       && cp -r data       dist/start.dist/
          [ -d static ]     && cp -r static     dist/start.dist/
          [ -d templates ]  && cp -r templates  dist/start.dist/
          [ -d config ]     && cp -r config     dist/start.dist/

          mv dist/start.dist app

      - name: ğŸ—‘ï¸ Cleanup artifacts
        run: |
          rm -rf dist start.build *.spec

      - name: ğŸ“¦ Package Linux ARM64 release
        run: |
          # åˆ é™¤å¯èƒ½å†²çªçš„ç›®å½•
          rm -rf characters data static templates config

          # ç§»åŠ¨ app å†…å®¹åˆ°æ ¹ç›®å½•
          mv app/* ./
          rmdir app

          # é‡å‘½åå¯æ‰§è¡Œæ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          [ -f start ] && mv start app

          # å‹ç¼©ä¸º zip
          zip -r Linux-ARM64-Full-Release-${{ inputs.version }}.zip . -x "*.git*" -x "*.zip"

      - name: ğŸ“¤ Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Linux-ARM64-Full-Release-${{ inputs.version }}
          path: Linux-ARM64-Full-Release-${{ inputs.version }}.zip

  build-linux-arm64-lite:
    runs-on: ubuntu-latest-arm64
    timeout-minutes: 120
    steps: # å¤ç”¨å®Œæ•´ç‰ˆæ­¥éª¤ï¼Œä½†ä¸å®‰è£…é¢å¤–ä¾èµ–
      - name: ğŸ›’ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: ğŸ§¹ Clean excluded files (.nobuild)
        run: |
          if [ -f .nobuild ]; then
            while IFS= read -r line; do
              [[ -z "$line" || "$line" =~ ^[[:space:]]*# ]] && continue
              if [ -e "$line" ]; then
                rm -rf "$line"
                echo "Removed: $line"
              fi
            done < .nobuild
          fi
          find . -type d -empty -delete

      - name: ğŸ“¦ Install dependencies (Lite)
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install nuitka

      - name: ğŸ§ Build Linux ARM64 executable
        run: |
          python -m nuitka --assume-yes-for-downloads --standalone --enable-plugin=pylint-warnings --include-package=services --include-package=utils --include-package=utils.RAG --include-package=utils.RAG.Multi_Recall --include-package=utils.RAG.Reranker --include-package=rtoml --output-dir=dist start.py

          mkdir -p dist/start.dist/characters dist/start.dist/data dist/start.dist/static dist/start.dist/templates dist/start.dist/config
          [ -d characters ] && cp -r characters dist/start.dist/
          [ -d data ]       && cp -r data       dist/start.dist/
          [ -d static ]     && cp -r static     dist/start.dist/
          [ -d templates ]  && cp -r templates  dist/start.dist/
          [ -d config ]     && cp -r config     dist/start.dist/

          mv dist/start.dist app

      - name: ğŸ—‘ï¸ Cleanup artifacts
        run: |
          rm -rf dist start.build *.spec

      - name: ğŸ“¦ Package Linux ARM64 release
        run: |
          # åˆ é™¤å¯èƒ½å†²çªçš„ç›®å½•
          rm -rf characters data static templates config

          # ç§»åŠ¨ app å†…å®¹åˆ°æ ¹ç›®å½•
          mv app/* ./
          rmdir app

          # é‡å‘½åå¯æ‰§è¡Œæ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          [ -f start ] && mv start app

          # å‹ç¼©ä¸º zip
          zip -r Linux-ARM64-Lite-Release-${{ inputs.version }}.zip . -x "*.git*" -x "*.zip"

      - name: ğŸ“¤ Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Linux-ARM64-Lite-Release-${{ inputs.version }}
          path: Linux-ARM64-Lite-Release-${{ inputs.version }}.zip

  # ==================== MACOS JOBS ====================
  build-macos-x64-full:
    runs-on: macos-13
    timeout-minutes: 120
    steps: &macos-steps
      - name: ğŸ›’ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: ğŸ§¹ Clean excluded files (.nobuild)
        run: |
          if [ -f .nobuild ]; then
            while IFS= read -r line; do
              [[ -z "$line" || "$line" =~ ^[[:space:]]*# ]] && continue
              if [ -e "$line" ]; then
                rm -rf "$line"
                echo "Removed: $line"
              fi
            done < .nobuild
          fi
          find . -type d -empty -delete

      - name: ğŸ“¦ Install dependencies (Full)
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install nuitka
          pip install rank_bm25 jieba torch tqdm

      - name: ğŸ Build macOS executable
        run: |
          python -m nuitka --assume-yes-for-downloads --standalone --enable-plugin=pylint-warnings --include-package=services --include-package=utils --include-package=utils.RAG --include-package=utils.RAG.Multi_Recall --include-package=utils.RAG.Reranker --include-package=rtoml --output-dir=dist start.py

          mkdir -p dist/start.dist/characters dist/start.dist/data dist/start.dist/static dist/start.dist/templates dist/start.dist/config
          [ -d characters ] && cp -r characters dist/start.dist/
          [ -d data ]       && cp -r data       dist/start.dist/
          [ -d static ]     && cp -r static     dist/start.dist/
          [ -d templates ]  && cp -r templates  dist/start.dist/
          [ -d config ]     && cp -r config     dist/start.dist/

          mv dist/start.dist app

      - name: ğŸ—‘ï¸ Cleanup artifacts
        run: |
          rm -rf dist start.build *.spec

      - name: ğŸ“¦ Package macOS release
        run: |
          # åˆ é™¤å¯èƒ½å†²çªçš„ç›®å½•
          rm -rf characters data static templates config

          # ç§»åŠ¨ app å†…å®¹åˆ°æ ¹ç›®å½•
          mv app/* ./
          rmdir app

          # é‡å‘½åå¯æ‰§è¡Œæ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          [ -f start ] && mv start app

          # å‹ç¼©ä¸º zip
          zip -r macOS-x64-Full-Release-${{ inputs.version }}.zip . -x "*.git*" -x "*.zip"

      - name: ğŸ“¤ Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: macOS-x64-Full-Release-${{ inputs.version }}
          path: macOS-x64-Full-Release-${{ inputs.version }}.zip

  build-macos-x64-lite:
    runs-on: macos-13
    timeout-minutes: 120
    steps: *macos-steps # å¤ç”¨å®Œæ•´ç‰ˆæ­¥éª¤ï¼Œä½†ä¸å®‰è£…é¢å¤–ä¾èµ–

  build-macos-arm64-full:
    runs-on: macos-latest
    timeout-minutes: 120
    steps:
      - name: ğŸ›’ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: ğŸ§¹ Clean excluded files (.nobuild)
        run: |
          if [ -f .nobuild ]; then
            while IFS= read -r line; do
              [[ -z "$line" || "$line" =~ ^[[:space:]]*# ]] && continue
              if [ -e "$line" ]; then
                rm -rf "$line"
                echo "Removed: $line"
              fi
            done < .nobuild
          fi
          find . -type d -empty -delete

      - name: ğŸ“¦ Install dependencies (Full)
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install nuitka
          pip install rank_bm25 jieba torch tqdm

      - name: ğŸ Build macOS ARM64 executable
        run: |
          python -m nuitka --assume-yes-for-downloads --standalone --enable-plugin=pylint-warnings --include-package=services --include-package=utils --include-package=utils.RAG --include-package=utils.RAG.Multi_Recall --include-package=utils.RAG.Reranker --include-package=rtoml --output-dir=dist start.py

          mkdir -p dist/start.dist/characters dist/start.dist/data dist/start.dist/static dist/start.dist/templates dist/start.dist/config
          [ -d characters ] && cp -r characters dist/start.dist/
          [ -d data ]       && cp -r data       dist/start.dist/
          [ -d static ]     && cp -r static     dist/start.dist/
          [ -d templates ]  && cp -r templates  dist/start.dist/
          [ -d config ]     && cp -r config     dist/start.dist/

          mv dist/start.dist app

      - name: ğŸ—‘ï¸ Cleanup artifacts
        run: |
          rm -rf dist start.build *.spec

      - name: ğŸ“¦ Package macOS ARM64 release
        run: |
          # åˆ é™¤å¯èƒ½å†²çªçš„ç›®å½•
          rm -rf characters data static templates config

          # ç§»åŠ¨ app å†…å®¹åˆ°æ ¹ç›®å½•
          mv app/* ./
          rmdir app

          # é‡å‘½åå¯æ‰§è¡Œæ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          [ -f start ] && mv start app

          # å‹ç¼©ä¸º zip
          zip -r macOS-ARM64-Full-Release-${{ inputs.version }}.zip . -x "*.git*" -x "*.zip"

      - name: ğŸ“¤ Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: macOS-ARM64-Full-Release-${{ inputs.version }}
          path: macOS-ARM64-Full-Release-${{ inputs.version }}.zip

  build-macos-arm64-lite:
    runs-on: macos-latest
    timeout-minutes: 120
    steps: # å¤ç”¨å®Œæ•´ç‰ˆæ­¥éª¤ï¼Œä½†ä¸å®‰è£…é¢å¤–ä¾èµ–
      - name: ğŸ›’ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: ğŸ§¹ Clean excluded files (.nobuild)
        run: |
          if [ -f .nobuild ]; then
            while IFS= read -r line; do
              [[ -z "$line" || "$line" =~ ^[[:space:]]*# ]] && continue
              if [ -e "$line" ]; then
                rm -rf "$line"
                echo "Removed: $line"
              fi
            done < .nobuild
          fi
          find . -type d -empty -delete

      - name: ğŸ“¦ Install dependencies (Lite)
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install nuitka

      - name: ğŸ Build macOS ARM64 executable
        run: |
          python -m nuitka --assume-yes-for-downloads --standalone --enable-plugin=pylint-warnings --include-package=services --include-package=utils --include-package=utils.RAG --include-package=utils.RAG.Multi_Recall --include-package=utils.RAG.Reranker --include-package=rtoml --output-dir=dist start.py

          mkdir -p dist/start.dist/characters dist/start.dist/data dist/start.dist/static dist/start.dist/templates dist/start.dist/config
          [ -d characters ] && cp -r characters dist/start.dist/
          [ -d data ]       && cp -r data       dist/start.dist/
          [ -d static ]     && cp -r static     dist/start.dist/
          [ -d templates ]  && cp -r templates  dist/start.dist/
          [ -d config ]     && cp -r config     dist/start.dist/

          mv dist/start.dist app

      - name: ğŸ—‘ï¸ Cleanup artifacts
        run: |
          rm -rf dist start.build *.spec

      - name: ğŸ“¦ Package macOS ARM64 release
        run: |
          # åˆ é™¤å¯èƒ½å†²çªçš„ç›®å½•
          rm -rf characters data static templates config

          # ç§»åŠ¨ app å†…å®¹åˆ°æ ¹ç›®å½•
          mv app/* ./
          rmdir app

          # é‡å‘½åå¯æ‰§è¡Œæ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          [ -f start ] && mv start app

          # å‹ç¼©ä¸º zip
          zip -r macOS-ARM64-Lite-Release-${{ inputs.version }}.zip . -x "*.git*" -x "*.zip"

      - name: ğŸ“¤ Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: macOS-ARM64-Lite-Release-${{ inputs.version }}
          path: macOS-ARM64-Lite-Release-${{ inputs.version }}.zip

  # ==================== PUBLISH ALL ====================
  publish-release:
    needs:
      - build-windows-x64-full
      - build-windows-x64-lite
      - build-windows-x86-full
      - build-windows-x86-lite
      # - build-windows-arm64-full # æš‚æ—¶è·³è¿‡ ARM64
      # - build-windows-arm64-lite
      - build-linux-x64-full
      - build-linux-x64-lite
      - build-linux-arm64-full
      - build-linux-arm64-lite
      - build-macos-x64-full
      - build-macos-x64-lite
      - build-macos-arm64-full
      - build-macos-arm64-lite
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: ğŸ›’ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¥ Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: ğŸ—‘ï¸ Delete existing release/tag if exists
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release delete "${{ inputs.version }}" --yes 2>/dev/null || echo "No existing release to delete."
          git tag -d "${{ inputs.version }}" 2>/dev/null || echo "No local tag to delete."
          git push --delete origin "${{ inputs.version }}" 2>/dev/null || echo "No remote tag to delete."

      - name: ğŸš€ Create Release and Upload Assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd artifacts
          # Flatten all zip files to current dir
          find . -type f -name "*.zip" -exec mv {} . \; 2>/dev/null || true
          # Remove any left empty dirs
          find . -type d -empty -delete

          gh release create "${{ inputs.version }}" \
            --title "${{ inputs.release_name || inputs.version }}" \
            --notes "${{ inputs.release_text }}" \
            Windows-x64-Full-Release-${{ inputs.version }}.zip \
            Windows-x64-Lite-Release-${{ inputs.version }}.zip \
            Windows-x86-Full-Release-${{ inputs.version }}.zip \
            Windows-x86-Lite-Release-${{ inputs.version }}.zip \
            Linux-x64-Full-Release-${{ inputs.version }}.zip \
            Linux-x64-Lite-Release-${{ inputs.version }}.zip \
            Linux-ARM64-Full-Release-${{ inputs.version }}.zip \
            Linux-ARM64-Lite-Release-${{ inputs.version }}.zip \
            macOS-x64-Full-Release-${{ inputs.version }}.zip \
            macOS-x64-Lite-Release-${{ inputs.version }}.zip \
            macOS-ARM64-Full-Release-${{ inputs.version }}.zip \
            macOS-ARM64-Lite-Release-${{ inputs.version }}.zip
