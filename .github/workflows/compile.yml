name: Create Release Package

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g. v1.0.0)'
        required: true
        default: 'v1.0.0'
      release_name:
        description: 'Release title (optional)'
        required: false

permissions:
  contents: write

jobs:
  build-release:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ›’ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: âš™ï¸ Create virtual environment
        run: |
          python -m venv venv
          source venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: ðŸ“¦ Package application (with dependencies)
        run: |
          # åˆ›å»ºå‘å¸ƒç›®å½•ç»“æž„
          mkdir -p dist/app
          
          # å¤åˆ¶é¡¹ç›®æ–‡ä»¶ï¼ˆæŽ’é™¤å¼€å‘ä¸“ç”¨æ–‡ä»¶ï¼‰
          rsync -r --exclude '.git' --exclude '.github' --exclude 'venv' \
                --exclude '*.pyc' --exclude '__pycache__' . dist/app/
          
          # å¤åˆ¶è™šæ‹ŸçŽ¯å¢ƒ
          cp -r venv dist/
          
          # åˆ›å»ºå¯åŠ¨è„šæœ¬ï¼ˆä¿®å¤ç¼©è¿›é—®é¢˜çš„å…³é”®ï¼‰
          echo '#!/bin/bash' > dist/run.sh
          echo 'source venv/bin/activate' >> dist/run.sh
          echo 'cd app' >> dist/run.sh
          echo 'python start.py' >> dist/run.sh
          chmod +x dist/run.sh
          
          # æ‰“åŒ…ä¸ºZIP
          zip -r "release-${{ inputs.version }}.zip" dist

      - name: ðŸš€ Create Release & Upload Asset
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "${{ inputs.version }}" \
            --title "${{ inputs.release_name || inputs.version }}" \
            --notes "Release with dependencies for Flask application" \
            "release-${{ inputs.version }}.zip"